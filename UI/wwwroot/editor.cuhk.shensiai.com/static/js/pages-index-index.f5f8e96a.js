(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-index-index"],{"0fba":function(e,t,n){var c=n("1c6c");"string"===typeof c&&(c=[[e.i,c,""]]),c.locals&&(e.exports=c.locals);var a=n("4f06").default;a("4e255ff2",c,!0,{sourceMap:!1,shadowMode:!1})},"18b4":function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return o})),n.d(t,"a",(function(){return c}));var c={uniDataCheckbox:n("75ff").default,uniIcons:n("6fd6").default,uNumberBox:n("7643").default,uButton:n("d512").default,uLine:n("f490").default},a=function(){var e=this,t=e.$createElement,c=e._self._c||t;return c("v-uni-view",{staticClass:"content"},[c("v-uni-view",{staticClass:"header"},[c("v-uni-view",{staticClass:"navbar"},[c("v-uni-view",{staticClass:"logo"},[c("v-uni-image",{attrs:{src:n("9781"),mode:"heightFix"}}),c("v-uni-text",[e._v("模型编辑系统")])],1),c("v-uni-view",{staticClass:"navbar-middle"},[c("uni-data-checkbox",{attrs:{mode:"tag",localdata:e.objecttype},on:{change:function(t){arguments[0]=t=e.$handleEvent(t),e.getObjectlist.apply(void 0,arguments)}},model:{value:e.curtype,callback:function(t){e.curtype=t},expression:"curtype"}})],1),c("v-uni-view",{staticClass:"navbar-right pointer"},[c("v-uni-view",{staticClass:"navbar-menu"},[e.userInfo.username?[c("v-uni-view",{staticClass:"menu-item username"},[c("uni-icons",{staticClass:"person",attrs:{type:"person",color:"#666",size:"13"}}),c("v-uni-text",[e._v(e._s(e.userInfo.username))])],1),c("v-uni-view",{staticClass:"menu-item "},[c("v-uni-text",{staticClass:"logout pointer hover-highlight",on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.logout.apply(void 0,arguments)}}},[e._v("退出")])],1)]:e._e(),c("v-uni-view",{staticClass:"popup-menu__arrow"})],2)],1)],1)],1),c("v-uni-view",{staticClass:"bottom"},[c("v-uni-view",{staticClass:"left"},[c("v-uni-view",{staticClass:"title"},[e._v(e._s(e.source))]),c("v-uni-view",{staticClass:"title"},[e._v("可选物品")]),c("uni-data-checkbox",{attrs:{mode:"list",localdata:e.objectlist},model:{value:e.curobject,callback:function(t){e.curobject=t},expression:"curobject"}})],1),c("v-uni-view",{staticClass:"middle"},[c("v-uni-view",{staticClass:"main",attrs:{id:"topScene"},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.onTableClick.apply(void 0,arguments)}}},[c("v-uni-view",{staticClass:"ctrlBar"},[c("v-uni-view",{staticClass:"ctrlItem"},[c("v-uni-view",{staticClass:"title"},[e._v("画面大小")]),c("v-uni-view",{staticClass:"item-content",on:{click:function(t){t.stopPropagation(),arguments[0]=t=e.$handleEvent(t),e.bindClick.apply(void 0,arguments)}}},[c("v-uni-slider",{attrs:{min:0,"block-size":12,max:100,value:e.topFov},on:{change:function(t){arguments[0]=t=e.$handleEvent(t),e.changeFov(t.detail.value)}}})],1)],1)],1)],1),c("v-uni-view",{staticClass:"main",attrs:{id:"editScene"}},[e.selectedObject<e.topScene.transform.length?c("v-uni-view",{staticClass:"ctrlBar"},[c("v-uni-view",{staticClass:"ctrlItem"},[c("v-uni-view",{staticClass:"title"},[e._v("物体大小")]),c("v-uni-view",{staticClass:"item-content"},[c("v-uni-slider",{attrs:{min:5,value:e.topScene.transform[e.selectedObject].scale,"block-size":12,max:70},on:{change:function(t){arguments[0]=t=e.$handleEvent(t),e.changeObject("scale",t.detail.value)}}})],1)],1),c("v-uni-view",{staticClass:"ctrlItem"},[c("v-uni-view",{staticClass:"title"},[e._v("物体位移")]),c("v-uni-view",{staticClass:"item-content"},[c("v-uni-text",{staticClass:"title"},[e._v("X:")]),c("u-number-box",{attrs:{"input-width":100,step:.01,"positive-integer":!1},on:{change:function(t){arguments[0]=t=e.$handleEvent(t),e.changeObject("position",t.value)}},model:{value:e.topScene.transform[e.selectedObject].pos.x,callback:function(t){e.$set(e.topScene.transform[e.selectedObject].pos,"x",t)},expression:"topScene.transform[selectedObject].pos.x"}}),c("v-uni-text",{staticClass:"title"},[e._v("Y:")]),c("u-number-box",{attrs:{"input-width":100,step:.01,"positive-integer":!1},on:{change:function(t){arguments[0]=t=e.$handleEvent(t),e.changeObject("position",t.value)}},model:{value:e.topScene.transform[e.selectedObject].pos.y,callback:function(t){e.$set(e.topScene.transform[e.selectedObject].pos,"y",t)},expression:"topScene.transform[selectedObject].pos.y"}})],1)],1),c("v-uni-view",{staticClass:"ctrlItem"},[c("v-uni-view",{staticClass:"title"},[e._v("物体旋转")]),c("v-uni-view",{staticClass:"item-content"},[c("v-uni-text",{staticClass:"title"},[e._v("X:")]),c("u-number-box",{attrs:{"input-width":100,step:1,max:360},on:{change:function(t){arguments[0]=t=e.$handleEvent(t),e.changeObject("rotation",t.value)}},model:{value:e.topScene.transform[e.selectedObject].rotate.x,callback:function(t){e.$set(e.topScene.transform[e.selectedObject].rotate,"x",t)},expression:"topScene.transform[selectedObject].rotate.x"}}),c("v-uni-text",{staticClass:"title"},[e._v("Y:")]),c("u-number-box",{attrs:{"input-width":100,step:1,max:360},on:{change:function(t){arguments[0]=t=e.$handleEvent(t),e.changeObject("rotation",t.value)}},model:{value:e.topScene.transform[e.selectedObject].rotate.y,callback:function(t){e.$set(e.topScene.transform[e.selectedObject].rotate,"y",t)},expression:"topScene.transform[selectedObject].rotate.y"}}),c("v-uni-text",{staticClass:"title"},[e._v("Z:")]),c("u-number-box",{attrs:{"input-width":100,step:1,max:360},on:{change:function(t){arguments[0]=t=e.$handleEvent(t),e.changeObject("rotation",t.value)}},model:{value:e.topScene.transform[e.selectedObject].rotate.z,callback:function(t){e.$set(e.topScene.transform[e.selectedObject].rotate,"z",t)},expression:"topScene.transform[selectedObject].rotate.z"}})],1)],1)],1):e._e()],1)],1),c("v-uni-view",{staticClass:"right"},[c("v-uni-view",{staticClass:"title",staticStyle:{"margin-bottom":"30rpx"}},[e._v("已添加物体")]),c("uni-data-checkbox",{attrs:{mode:"list",icon:"right",localdata:e.topScene.transform},model:{value:e.selectedObject,callback:function(t){e.selectedObject=t},expression:"selectedObject"}}),c("u-button",{attrs:{type:"warning",disabled:0==e.topScene.transform.length},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.deleteObject.apply(void 0,arguments)}}},[e._v("删除选中")]),c("u-line",{attrs:{color:"blue",margin:"30rpx 0"}}),c("u-button",{attrs:{type:"primary",disabled:0==e.topScene.transform.length},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.saveProject.apply(void 0,arguments)}}},[e._v("保存")]),c("u-line",{attrs:{color:"blue",margin:"30rpx 0"}}),c("u-button",{attrs:{type:"success"},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.reload.apply(void 0,arguments)}}},[e._v("加载空场景")]),c("u-line",{attrs:{color:"blue",margin:"30rpx 0"}}),c("u-button",{attrs:{type:"success"},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.reloadfromproject.apply(void 0,arguments)}}},[e._v("加载已有场景")])],1)],1)],1)},o=[]},"1c6c":function(e,t,n){var c=n("24fb");t=c(!1),t.push([e.i,'@charset "UTF-8";\r\n/**\r\n * 这里是uni-app内置的常用样式变量\r\n *\r\n * uni-app 官方扩展插件及插件市场（https://ext.dcloud.net.cn）上很多三方插件均使用了这些样式变量\r\n * 如果你是插件开发者，建议你使用scss预处理，并在插件代码中直接使用这些变量（无需 import 这个文件），方便用户通过搭积木的方式开发整体风格一致的App\r\n *\r\n */\r\n/**\r\n * 如果你是App开发者（插件使用者），你可以通过修改这些变量来定制自己的插件主题，实现自定义主题功能\r\n *\r\n * 如果你的项目同样使用了scss预处理，你也可以直接在你的 scss 代码中使用如下变量，同时无需 import 这个文件\r\n */\r\n/* 颜色变量 */\r\n/* 行为相关颜色 */\r\n/* 文字基本颜色 */\r\n/* 背景颜色 */\r\n/* 边框颜色 */\r\n/* 尺寸变量 */\r\n/* 文字尺寸 */\r\n/* 图片尺寸 */\r\n/* Border Radius */\r\n/* 水平间距 */\r\n/* 垂直间距 */\r\n/* 透明度 */\r\n/* 文章场景相关 */.content[data-v-4a134504]{top:0;bottom:0;position:absolute;display:flex;flex-direction:column;width:100%;display:flex;flex-direction:column}.content .header[data-v-4a134504]{width:100%;box-sizing:border-box;color:#666;border-bottom:1px solid rgba(0,0,0,.3)}.content .header .navbar[data-v-4a134504]{font-size:14px;position:relative;height:%?230?%;display:flex;justify-content:space-between;align-items:center}.content .header .navbar .navbar-right[data-v-4a134504]{width:%?300?%}.content .header .logo[data-v-4a134504]{width:%?300?%;display:flex;align-items:center;justify-content:center;flex-direction:column}.content .header .logo uni-image[data-v-4a134504]{height:%?150?%}.content .header .logo uni-text[data-v-4a134504]{margin-left:8px}.content .header .navbar-menu[data-v-4a134504]{display:flex;align-items:center;justify-content:flex-start;align-content:center}.content .header .menu-item[data-v-4a134504]{padding:8px;font-size:13px;color:#666;line-height:1}.content .header .navbar-middle[data-v-4a134504]{flex:1}.content .bottom[data-v-4a134504]{flex:1;display:flex}.content .bottom .left[data-v-4a134504]{width:%?300?%;height:100%;padding:10px;border-right:1px solid rgba(0,0,0,.3)}.content .bottom .left .title[data-v-4a134504]{text-align:center}.content .bottom .right[data-v-4a134504]{width:%?300?%;height:100%;padding:10px;box-sizing:border-box;border-left:1px solid rgba(0,0,0,.3)}.content .bottom .right .title[data-v-4a134504]{text-align:center}.content .bottom .middle[data-v-4a134504]{flex:1;height:100%;display:flex}.content .bottom .middle .main[data-v-4a134504]{width:calc(50vw - %?300?%);height:100%}.content .bottom .middle .main .ctrlBar[data-v-4a134504]{background-color:rgba(0,0,0,.5);position:fixed;bottom:0;width:calc(48vw - %?300?%);margin-left:1vw;padding-top:10px;z-index:99}.content .bottom .middle .main .ctrlBar-right[data-v-4a134504]{left:51vw}.ctrlItem[data-v-4a134504]{width:100%;display:flex;align-items:center;align-content:center;margin-bottom:10px}.ctrlItem .title[data-v-4a134504]{width:80px;color:#fff;text-align:center;font-size:10px;padding:0 10px}.ctrlItem .item-content[data-v-4a134504]{flex:1}',""]),e.exports=t},2146:function(e,t,n){"use strict";var c=n("0fba"),a=n.n(c);a.a},"4a9c":function(e,t,n){"use strict";n.r(t);var c=n("8441"),a=n.n(c);for(var o in c)"default"!==o&&function(e){n.d(t,e,(function(){return c[e]}))}(o);t["default"]=a.a},8441:function(e,t,n){"use strict";(function(e){var c=n("dbce"),a=n("4ea4");n("4160"),n("c975"),n("d81d"),n("a434"),n("ac1f"),n("466d"),n("5319"),n("159b"),Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,n("96cf");var o=a(n("1da1")),i=a(n("5530")),s=n("2f62"),r=a(n("72f7")),l=c(n("59ff")),d=n("672f"),u=n("67c1"),p=n("deb8"),h=n("d503"),m=e.database(),b=m.command,v={computed:(0,i.default)({},(0,s.mapState)("user",["userInfo"])),data:function(){return{curtype:0,curobject:null,curtable:null,source:"",viewportInfo:null,topFov:45,objecttype:[],objectlist:[],center:null,tablevectices:[],tableZ:0,topScene:{scene:null,camera:null,renderer:null,raycaster:null,mesh:null,objects:[],transform:[],oldobj:[]},editScene:{scene:null,camera:null,renderer:null,controls:null,mesh:null,objects:[],oldobj:[]},selectedObject:0,project_id:null,server:"//editor.cuhk.shensiai.com",itemCount:999}},mounted:function(){var e=this;uni.showLoading({title:"正在加载场景",mask:!0}),m.collection("cuhk-projects").aggregate().match({tables:b.neq("[]")}).sample({size:1}).end().then((function(t){var n=t.result.data[0];m.collection("cuhk-scenes").where({scene_name:n.scenename,instance:n.instance,semantic:n.semantic}).get().then((function(t){e.curtable=t.result.data[0],e.center=new l.Vector3(e.curtable.position.x,e.curtable.position.y,e.curtable.position.z),e.getObjecttypelist(),e.init();var c=JSON.parse(n.objectlist);e.index=c.length-1,c.map((function(t){e.loadobj(t)}))}))}))},onShow:function(){},methods:(0,i.default)((0,i.default)({},(0,s.mapMutations)({removeToken:function(e){e("user/REMOVE_TOKEN")}})),{},{logout:function(){this.removeToken(),uni.reLaunch({url:r.default.login.url})},getObjecttypelist:function(){var e=this;m.collection("cuhk-object-type").where({tables:this.curtable.table_name}).field("type_id as value, type_name_cn as text").limit(100).get({getCount:!0}).then((function(t){e.objecttype=t.result.data,e.curtype=e.objecttype[0].value,e.source=e.objecttype[0].source,m.collection("cuhk-objects").aggregate().match({type:e.curtype}).sample({size:15}).end().then((function(t){e.objectlist=[];for(var n=1;n<=t.result.data.length;n++)e.objectlist.push({value:n-1,text:e.objecttype[0].text+n,name:t.result.data[n-1].name,path:t.result.data[n-1].path})}))}))},getObjectlist:function(e){var t=this;this.source=e.detail.data.source,m.collection("cuhk-objects").aggregate().match({type:e.detail.value}).sample({size:15}).end().then((function(n){t.objectlist=[];for(var c=1;c<=n.result.data.length;c++)t.objectlist.push({value:c-1,text:e.detail.data.text+c,name:n.result.data[c-1].name,path:n.result.data[c-1].path});t.onWindowResize()}))},init:function(){var e=this;return(0,o.default)(regeneratorRuntime.mark((function t(){var n,c;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=document.getElementById("topScene"),t.next=3,e.$utils.getElementInfo("topScene");case 3:e.viewportInfo=t.sent,e.initScene(n,e.topScene),c=document.getElementById("editScene"),e.initScene(c,e.editScene),window.addEventListener("resize",e.onWindowResize),e.loadTopScene(),e.loadEditScene(),e.updateScene();case 11:case"end":return t.stop()}}),t)})))()},initScene:function(e,t){var n=this;return(0,o.default)(regeneratorRuntime.mark((function c(){var a,o,i;return regeneratorRuntime.wrap((function(c){while(1)switch(c.prev=c.next){case 0:a=n.viewportInfo.width/n.viewportInfo.height,t.renderer=new l.WebGLRenderer({antialias:!0}),t.renderer.setPixelRatio(window.devicePixelRatio),t.renderer.setSize(n.viewportInfo.width,n.viewportInfo.height),t.renderer.shadowMap.enabled=!0,e.appendChild(t.renderer.domElement),t.scene=new l.Scene,t.scene.background=new l.Color(10526880),t.camera=new l.PerspectiveCamera(50,a,.1,1e3),t.camera.position.set(4.353,3.818,1.723),t.camera.up=new l.Vector3(0,0,1),o=new l.HemisphereLight(16777215,4473924),o.position.set(0,200,0),t.scene.add(o),i=new l.DirectionalLight(16777215),i.position.set(0,200,100),i.castShadow=!0,i.shadow.camera.top=180,i.shadow.camera.bottom=-100,i.shadow.camera.left=-120,i.shadow.camera.right=120,t.scene.add(i);case 22:case"end":return c.stop()}}),c)})))()},loadEditScene:function(){var e=this;return(0,o.default)(regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:null!=e.editScene.mesh&&e.editScene.scene.remove(e.editScene.mesh),e.editScene.objects.map((function(t){e.editScene.scene.remove(t)})),e.editScene.oldobj.map((function(t){e.editScene.scene.remove(t)})),e.editScene.objects=[],e.center=new l.Vector3(e.curtable.position.x,e.curtable.position.y,e.curtable.position.z),e.editScene.camera.lookAt(e.center),null==e.editScene.controls&&(e.editScene.controls=new h.OrbitControls(e.editScene.camera,e.editScene.renderer.domElement)),e.editScene.controls.target.set(e.curtable.position.x,e.curtable.position.y,e.curtable.position.z),e.editScene.controls.update(),e.editScene.camera.updateMatrixWorld(),e.editScene.camera.updateProjectionMatrix(),n=new d.PLYLoader,n.load(e.server+e.curtable.path,e.curtable.instance,(function(t){t.computeVertexNormals();var n=new l.MeshPhongMaterial({color:16777215,specular:273,shininess:10,vertexColors:l.VertexColors});e.editScene.mesh=new l.Mesh(t,n),e.editScene.mesh.position.set(0,0,0),e.editScene.mesh.scale.multiplyScalar(1),e.editScene.mesh.castShadow=!1,e.editScene.mesh.receiveShadow=!1,e.editScene.scene.add(e.editScene.mesh),uni.hideLoading()}));case 13:case"end":return t.stop()}}),t)})))()},loadTopScene:function(){var e=this;return(0,o.default)(regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:null!=e.topScene.mesh&&e.topScene.scene.remove(e.topScene.mesh),e.topScene.objects.map((function(t){e.topScene.scene.remove(t)})),e.topScene.oldobj.map((function(t){e.topScene.scene.remove(t)})),e.topScene.objects=[],e.topScene.transform=[],e.topScene.raycaster=new l.Raycaster,e.topScene.camera.position.set(e.curtable.position.x,e.curtable.position.y,e.curtable.position.z+3),e.topScene.camera.lookAt(new l.Vector3(e.curtable.position.x,e.curtable.position.y,e.curtable.position.z)),e.topScene.camera.updateMatrixWorld(),n=new d.PLYLoader,n.load(e.server+e.curtable.path,e.curtable.instance,(function(t){t.computeVertexNormals();var n=new l.MeshPhongMaterial({color:16777215,specular:273,shininess:10,vertexColors:l.VertexColors});e.topScene.mesh=new l.Mesh(t,n),e.topScene.mesh.position.set(0,0,0),e.topScene.mesh.scale.multiplyScalar(1),e.topScene.mesh.castShadow=!1,e.topScene.mesh.receiveShadow=!1,e.topScene.scene.add(e.topScene.mesh),e.topScene.scene.updateMatrixWorld(!0);var c=t.attributes.tablevectices;e.tablevectices=[];for(var a=0;a<c.count;a++){var o=new l.Vector3(c.array[3*a],c.array[3*a+1],c.array[3*a+2]);o.applyMatrix4(e.topScene.mesh.matrixWorld),e.tablevectices.push(o)}}));case 11:case"end":return t.stop()}}),t)})))()},reload:function(){var e=this;return(0,o.default)(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.objectlist=[],e.curtype=null,e.curobject=null,e.project_id=null,m.collection("cuhk-scenes").aggregate().match({tables:b.neq("[]")}).sample({size:1}).end().then((function(t){e.curtable=t.result.data[0],e.getObjecttypelist(),e.loadTopScene(),e.loadEditScene()}));case 5:case"end":return t.stop()}}),t)})))()},reloadfromproject:function(){var e=this;return(0,o.default)(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.objectlist=[],e.curtype=null,e.curobject=null,e.project_id=null,m.collection("cuhk-projects").aggregate().match({tables:b.neq("[]")}).sample({size:1}).end().then((function(t){var n=t.result.data[0];m.collection("cuhk-scenes").where({scene_name:n.scenename,instance:n.instance,semantic:n.semantic}).get().then((function(t){e.curtable=t.result.data[0],e.getObjecttypelist(),e.loadTopScene(),e.loadEditScene();var c=JSON.parse(n.objectlist);c.map((function(t){e.loadobj(t)}))}))}));case 5:case"end":return t.stop()}}),t)})))()},loadobj:function(e){var t=this;return(0,o.default)(regeneratorRuntime.mark((function n(){return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:m.collection("cuhk-objects").where({name:e.name}).get({getOne:!0}).then((function(n){var c=n.result.data;c.path.indexOf("ModelNet")>0&&(new u.OBJLoader).load(t.server+c.path,(function(n){n.children[0].material.color.set(15251259),n.position.set(e.pos.x,e.pos.y,e.pos.z),n.scale.set(.01*e.scale,.01*e.scale,.01*e.scale),n.rotation.set(e.rotate.x*Math.PI/180,e.rotate.y*Math.PI/180,e.rotate.z*Math.PI/180),t.editScene.scene.add(n),t.editScene.objects.push(n);var c=n.clone();t.topScene.scene.add(c),t.topScene.objects.push(c),t.selectedObject=t.topScene.transform.length,t.index++,t.topScene.transform.push({text:e.text,value:t.selectedObject,name:e.name,scale:e.scale,pos:e.pos,rotate:e.rotate})})),c.path.indexOf("ShapeNet")>0&&(new p.MTLLoader).load(t.server+c.path.replace(".obj",".mtl"),(function(n){n.preload(),(new u.OBJLoader).setMaterials(n).load(t.server+c.path,(function(n){n.position.set(e.pos.x,e.pos.y,e.pos.z),n.scale.set(.01*e.scale,.01*e.scale,.01*e.scale),n.rotation.set(e.rotate.x*Math.PI/180,e.rotate.y*Math.PI/180,e.rotate.z*Math.PI/180),t.editScene.scene.add(n),t.editScene.objects.push(n);var c=n.clone();t.topScene.scene.add(c),t.topScene.objects.push(c),t.selectedObject=t.topScene.transform.length,t.index++,t.topScene.transform.push({text:e.text,value:t.selectedObject,name:e.name,scale:e.scale,pos:e.pos,rotate:e.rotate})}))}))}));case 1:case"end":return n.stop()}}),n)})))()},changeObject:function(e,t){switch(e){case"scale":this.topScene.transform[this.selectedObject].scale=t;var n=.01*this.topScene.transform[this.selectedObject].scale;this.topScene.objects[this.selectedObject].scale.set(n,n,n),this.editScene.objects[this.selectedObject].scale.set(n,n,n),this.updateObject();break;case"position":this.topScene.objects[this.selectedObject].position.copy(this.topScene.transform[this.selectedObject].pos),this.editScene.objects[this.selectedObject].position.copy(this.topScene.transform[this.selectedObject].pos),this.updateObject();break;case"rotation":var c=this.topScene.transform[this.selectedObject].rotate;this.topScene.objects[this.selectedObject].rotation.set(c.x*Math.PI/180,c.y*Math.PI/180,c.z*Math.PI/180),this.editScene.objects[this.selectedObject].rotation.set(c.x*Math.PI/180,c.y*Math.PI/180,c.z*Math.PI/180),this.updateObject();break}},getObjectMinZ:function(e){e.updateMatrixWorld();var t=new l.Vector3;return e.getWorldPosition(t),e.children.forEach((function(n){for(var c=n.geometry.attributes.position,a=0;a<c.count;a++){var o=new l.Vector3(c.array[3*a],c.array[3*a+1],c.array[3*a+2]);o.applyMatrix4(e.matrixWorld),o.z<t.z&&(t=o.clone())}})),t},updateObject:function(){this.topScene.scene.updateMatrixWorld(!0);var e=new l.Box3;e.expandByObject(this.topScene.objects[this.selectedObject]);var t=this.getObjectMinZ(this.topScene.objects[this.selectedObject]),n=0,c=0,a=999;this.tablevectices.forEach((function(o){e.min.x<o.x&&o.x<e.max.x&&e.min.y<o.y&&o.y<e.max.y&&o.z>n&&(n=o.z);var i=t.distanceTo(o);i<a&&(c=o.z,a=i)})),0==n&&(n=c),this.topScene.transform[this.selectedObject].pos.z=this.topScene.transform[this.selectedObject].pos.z+n-t.z,this.topScene.objects[this.selectedObject].position.copy(this.topScene.transform[this.selectedObject].pos),this.editScene.objects[this.selectedObject].position.copy(this.topScene.transform[this.selectedObject].pos)},deleteObject:function(){this.topScene.transform.splice(this.selectedObject,1),this.topScene.scene.remove(this.topScene.objects[this.selectedObject]),this.editScene.scene.remove(this.editScene.objects[this.selectedObject]),this.topScene.objects.splice(this.selectedObject,1),this.editScene.objects.splice(this.selectedObject,1);for(var e=0;e<this.topScene.transform.length;e++)this.topScene.transform[e].value=e;this.selectedObject>0&&this.selectedObject--},saveProject:function(){var e=this;0!=this.topScene.transform.length?(uni.showLoading({title:"正在保存中",mask:!0}),null==this.project_id?m.collection("cuhk-projects").add({scenename:this.curtable.scene_name,semantic:this.curtable.semantic,instance:this.curtable.instance,center:this.center,objectlist:JSON.stringify(this.topScene.transform)}).then((function(t){e.project_id=t.result.id,uni.hideLoading(),uni.showModal({title:"保存成功",showCancel:!1})})):m.collection("cuhk-projects").doc(this.project_id).update({objectlist:JSON.stringify(this.topScene.transform)}).then((function(e){uni.hideLoading(),uni.showModal({title:"保存成功",showCancel:!1})}))):uni.showModal({title:"请先添加物品模型再保存",showCancel:!1})},changeFov:function(e){this.topScene.camera.fov=e,this.topScene.camera.updateProjectionMatrix()},bindClick:function(e){e.preventDefault()},onWindowResize:function(){var e=this;return(0,o.default)(regeneratorRuntime.mark((function t(){var n;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.$utils.getElementInfo("topScene");case 2:e.viewportInfo=t.sent,n=e.viewportInfo.width/e.viewportInfo.height,e.topScene.camera.aspect=n,e.topScene.camera.updateProjectionMatrix(),e.topScene.renderer.setSize(e.viewportInfo.width,e.viewportInfo.height),e.editScene.camera.aspect=n,e.editScene.camera.updateProjectionMatrix(),e.editScene.renderer.setSize(e.viewportInfo.width,e.viewportInfo.height);case 10:case"end":return t.stop()}}),t)})))()},onTableClick:function(e){var t=this;if(null!=this.curobject||0!=this.topScene.objects.length){var n=e.changedTouches[0],c=n.clientX,a=n.clientY,o=new l.Vector2;o.x=(c-this.viewportInfo.left)/this.topScene.renderer.domElement.clientWidth*2-1,o.y=-(a-this.viewportInfo.top)/this.topScene.renderer.domElement.clientHeight*2+1,this.topScene.raycaster.setFromCamera(o,this.topScene.camera);var i=this.topScene.raycaster.intersectObject(this.topScene.mesh);i.length>0&&(this.tableZ=i[0].point.z,null!=this.curobject?(uni.showLoading({title:"正在添加物体",mask:!0}),this.objectlist[this.curobject].path.indexOf("ModelNet")>0&&(new u.OBJLoader).load(this.server+this.objectlist[this.curobject].path,(function(e){e.children[0].material.color.set(15251259),t.addObj(e,i[0].point,"modelnet")})),this.objectlist[this.curobject].path.indexOf("ShapeNet")>0&&(new p.MTLLoader).load(this.server+this.objectlist[this.curobject].path.replace(".obj",".mtl"),(function(e){e.preload(),(new u.OBJLoader).setMaterials(e).load(t.server+t.objectlist[t.curobject].path,(function(e){t.addObj(e,i[0].point,"shapenet")}))}))):(this.topScene.transform[this.selectedObject].pos.x=i[0].point.x,this.topScene.transform[this.selectedObject].pos.y=i[0].point.y,this.topScene.objects[this.selectedObject].position.set(0,0,0),this.topScene.objects[this.selectedObject].position.copy(this.topScene.transform[this.selectedObject].pos),this.editScene.objects[this.selectedObject].position.set(0,0,0),this.editScene.objects[this.selectedObject].position.copy(this.topScene.transform[this.selectedObject].pos),this.updateObject()))}else uni.showModal({title:"请先选择一个物品并确定",showCancel:!1})},updateScene:function(){requestAnimationFrame(this.updateScene),this.topScene.renderer.render(this.topScene.scene,this.topScene.camera),this.editScene.renderer.render(this.editScene.scene,this.editScene.camera)},addObj:function(e,t,n){this.selectedObject=this.topScene.transform.length,e.position.set(0,0,0),e.scale.set(.5,.5,.5),"shapenet"==n&&(e.rotation.x=Math.PI/2),e.position.copy(t),this.topScene.scene.add(e),this.topScene.objects.push(e);var c=e.clone();this.editScene.scene.add(c),this.index++,this.topScene.transform.push({text:this.objectlist[this.curobject].text,value:this.selectedObject,name:this.objectlist[this.curobject].name,scale:50,pos:t,rotate:{x:"shapenet"==n?90:0,y:0,z:0}}),this.editScene.objects.push(c),this.curobject=null,uni.hideLoading()}})};t.default=v}).call(this,n("a9ff")["default"])},f6ad:function(e,t,n){"use strict";n.r(t);var c=n("18b4"),a=n("4a9c");for(var o in a)"default"!==o&&function(e){n.d(t,e,(function(){return a[e]}))}(o);n("2146");var i,s=n("f0c5"),r=Object(s["a"])(a["default"],c["b"],c["c"],!1,null,"4a134504",null,!1,c["a"],i);t["default"]=r.exports}}]);